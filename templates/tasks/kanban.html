{% extends 'base.html' %}

{% block title %}Kanban Board - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .kanban-column {
        min-height: 500px;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    .task-card {
        cursor: grab;
        margin-bottom: 10px;
    }
    .task-card:active {
        cursor: grabbing;
    }
    .column-header {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        background-color: #f1f1f1;
        border-radius: 0.25rem 0.25rem 0 0;
    }
    .column-body {
        padding: 10px;
        min-height: 450px;
    }
</style>
{% endblock %}

{% block content %}
<div class=&quot;row mb-4&quot;>
    <div class=&quot;col-md-8&quot;>
        <h1 class=&quot;mb-2&quot;>{{ project.name }} - Kanban Board</h1>
    </div>
    <div class=&quot;col-md-4 text-end&quot;>
        <div class=&quot;btn-group&quot; role=&quot;group&quot;>
            <a href=&quot;{{ url_for('projects.view_project', project_id=project.id) }}&quot; class=&quot;btn btn-outline-primary&quot;>
                <i class=&quot;fas fa-list me-1&quot;></i>List View
            </a>
            <a href=&quot;{{ url_for('tasks.create_task', project_id=project.id) }}&quot; class=&quot;btn btn-primary&quot;>
                <i class=&quot;fas fa-plus me-1&quot;></i>Add Task
            </a>
        </div>
    </div>
</div>
<div class=&quot;row&quot;>
    <div class=&quot;col-md-4 mb-4&quot;>
        <div class=&quot;kanban-column&quot;>
            <div class=&quot;column-header bg-secondary text-white&quot;>
                <h5 class=&quot;mb-0&quot;>To Do</h5>
            </div>
            <div class=&quot;column-body&quot; id=&quot;todo-column&quot; data-status=&quot;To Do&quot;>
                {% for task in task_columns['To Do'] %}
                    <div class=&quot;card task-card&quot; data-task-id=&quot;{{ task.id }}&quot;>
                        <div class=&quot;card-body&quot;>
                            <h5 class=&quot;card-title&quot;>{{ task.title }}</h5>
                            <p class=&quot;card-text&quot;>{{ task.description|truncate(100) if task.description else 'No description' }}</p>
                            <div class=&quot;d-flex justify-content-between align-items-center&quot;>
                                <span class=&quot;badge {% if task.priority == 'High' %}bg-danger{% elif task.priority == 'Medium' %}bg-warning{% else %}bg-info{% endif %}&quot;>
                                    {{ task.priority }}
                                </span>
                                <small>
                                    {% if task.assignee %}
                                        <i class=&quot;fas fa-user me-1&quot;></i>{{ task.assignee.username }}
                                    {% else %}
                                        <i class=&quot;fas fa-user-slash me-1&quot;></i>Unassigned
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class=&quot;card-footer d-flex justify-content-between align-items-center&quot;>
                            <small class=&quot;text-muted&quot;>
                                {% if task.due_date %}
                                    <i class=&quot;fas fa-calendar-alt me-1&quot;></i>{{ task.due_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                    <i class=&quot;fas fa-calendar-times me-1&quot;></i>No due date
                                {% endif %}
                            </small>
                            <a href=&quot;{{ url_for('tasks.view_task', task_id=task.id) }}&quot; class=&quot;btn btn-sm btn-outline-primary&quot;>
                                <i class=&quot;fas fa-eye&quot;></i>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class=&quot;col-md-4 mb-4&quot;>
        <div class=&quot;kanban-column&quot;>
            <div class=&quot;column-header bg-primary text-white&quot;>
                <h5 class=&quot;mb-0&quot;>In Progress</h5>
            </div>
            <div class=&quot;column-body&quot; id=&quot;in-progress-column&quot; data-status=&quot;In Progress&quot;>
                {% for task in task_columns['In Progress'] %}
                    <div class=&quot;card task-card&quot; data-task-id=&quot;{{ task.id }}&quot;>
                        <div class=&quot;card-body&quot;>
                            <h5 class=&quot;card-title&quot;>{{ task.title }}</h5>
                            <p class=&quot;card-text&quot;>{{ task.description|truncate(100) if task.description else 'No description' }}</p>
                            <div class=&quot;d-flex justify-content-between align-items-center&quot;>
                                <span class=&quot;badge {% if task.priority == 'High' %}bg-danger{% elif task.priority == 'Medium' %}bg-warning{% else %}bg-info{% endif %}&quot;>
                                    {{ task.priority }}
                                </span>
                                <small>
                                    {% if task.assignee %}
                                        <i class=&quot;fas fa-user me-1&quot;></i>{{ task.assignee.username }}
                                    {% else %}
                                        <i class=&quot;fas fa-user-slash me-1&quot;></i>Unassigned
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class=&quot;card-footer d-flex justify-content-between align-items-center&quot;>
                            <small class=&quot;text-muted&quot;>
                                {% if task.due_date %}
                                    <i class=&quot;fas fa-calendar-alt me-1&quot;></i>{{ task.due_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                    <i class=&quot;fas fa-calendar-times me-1&quot;></i>No due date
                                {% endif %}
                            </small>
                            <a href=&quot;{{ url_for('tasks.view_task', task_id=task.id) }}&quot; class=&quot;btn btn-sm btn-outline-primary&quot;>
                                <i class=&quot;fas fa-eye&quot;></i>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
   <div class=&quot;col-md-4 mb-4&quot;>
        <div class=&quot;kanban-column&quot;>
            <div class=&quot;column-header bg-success text-white&quot;>
                <h5 class=&quot;mb-0&quot;>Done</h5>
            </div>
            <div class=&quot;column-body&quot; id=&quot;done-column&quot; data-status=&quot;Done&quot;>
                {% for task in task_columns['Done'] %}
                    <div class=&quot;card task-card&quot; data-task-id=&quot;{{ task.id }}&quot;>
                        <div class=&quot;card-body&quot;>
                            <h5 class=&quot;card-title&quot;>{{ task.title }}</h5>
                            <p class=&quot;card-text&quot;>{{ task.description|truncate(100) if task.description else 'No description' }}</p>
                            <div class=&quot;d-flex justify-content-between align-items-center&quot;>
                                <span class=&quot;badge {% if task.priority == 'High' %}bg-danger{% elif task.priority == 'Medium' %}bg-warning{% else %}bg-info{% endif %}&quot;>
                                    {{ task.priority }}
                                </span>
                                <small>
                                    {% if task.assignee %}
                                        <i class=&quot;fas fa-user me-1&quot;></i>{{ task.assignee.username }}
                                    {% else %}
                                        <i class=&quot;fas fa-user-slash me-1&quot;></i>Unassigned
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class=&quot;card-footer d-flex justify-content-between align-items-center&quot;>
                            <small class=&quot;text-muted&quot;>
                                {% if task.due_date %}
                                    <i class=&quot;fas fa-calendar-alt me-1&quot;></i>{{ task.due_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                    <i class=&quot;fas fa-calendar-times me-1&quot;></i>No due date
                                {% endif %}
                            </small>
                            <a href=&quot;{{ url_for('tasks.view_task', task_id=task.id) }}&quot; class=&quot;btn btn-sm btn-outline-primary&quot;>
                                <i class=&quot;fas fa-eye&quot;></i>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
script src=&quot;https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js&quot;</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Sortable for each column
        const todoColumn = document.getElementById('todo-column');
        const inProgressColumn = document.getElementById('in-progress-column');
        const doneColumn = document.getElementById('done-column');

        const columns = [todoColumn, inProgressColumn, doneColumn];

        columns.forEach(column => {
            new Sortable(column, {
                group: 'tasks',
                animation: 150,
                ghostClass: 'bg-light',
                onEnd: function(evt) {
                    const taskId = evt.item.dataset.taskId;
                    const newStatus = evt.to.dataset.status;

                    // Update task status via API
                    fetch(`/tasks/${taskId}/status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ status: newStatus }),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to update task status');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Task status updated:', data);
                    })
                    .catch(error => {
                        console.error('Error updating task status:', error);
                        alert('Error updating task status. Please try again.');
                        // Revert the drag if there was an error
                        window.location.reload();
                    });
                }
            });
        });
    });
</script>
{% endblock %}

{% endblock %}